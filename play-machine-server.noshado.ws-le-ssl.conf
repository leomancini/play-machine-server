# Non-secure HTTP configuration
<VirtualHost *:80>
    ServerName play-machine-server.noshado.ws
    ServerAlias www.play-machine-server.noshado.ws
    ServerAdmin www@noshado.ws

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyVia Full
    <Proxy *>
        Require all granted
    </Proxy>

    # CORS headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Forwarded-Proto, X-Forwarded-Ssl"
    Header always set Access-Control-Allow-Credentials "true"

    # Handle OPTIONS method for CORS preflight
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Route /api/* to HTTP server
    ProxyPass /api/ http://127.0.0.1:3205/api/
    ProxyPassReverse /api/ http://127.0.0.1:3205/api/

    # Route WebSocket traffic
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) ws://127.0.0.1:3204/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*) http://127.0.0.1:3204/$1 [P,L]

    ProxyPass / http://127.0.0.1:3204/
    ProxyPassReverse / http://127.0.0.1:3204/

    ErrorLog /var/log/apache2/play-machine-server.noshado.ws-error.log
    CustomLog /var/log/apache2/play-machine-server.noshado.ws-access.log combined

    ProxyTimeout 3600
</VirtualHost>

# Secure HTTPS configuration
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName play-machine-server.noshado.ws
    ServerAlias www.play-machine-server.noshado.ws
    ServerAdmin www@noshado.ws

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyVia Full
    <Proxy *>
        Require all granted
    </Proxy>

    # CORS headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Forwarded-Proto, X-Forwarded-Ssl"
    Header always set Access-Control-Allow-Credentials "true"

    # Handle OPTIONS method for CORS preflight
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Route /api/* to HTTP server
    ProxyPass /api/ http://127.0.0.1:3205/api/
    ProxyPassReverse /api/ http://127.0.0.1:3205/api/

    # Route WebSocket traffic based on path
    RewriteEngine On
    
    # Secure WebSocket (wss://)
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{REQUEST_URI} ^/secure/ [NC]
    RewriteRule ^secure/(.*) ws://127.0.0.1:3103/$1 [P,L]
    
    # Non-secure WebSocket (ws://)
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{REQUEST_URI} !^/secure/ [NC]
    RewriteRule ^(.*) ws://127.0.0.1:3204/$1 [P,L]
    
    # Regular HTTPS traffic
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule ^(.*) http://127.0.0.1:3205/$1 [P,L]

    # Additional headers for WebSocket
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Ssl "on"

    ErrorLog /var/log/apache2/play-machine-server.noshado.ws-error.log
    CustomLog /var/log/apache2/play-machine-server.noshado.ws-access.log combined

    ProxyTimeout 3600

    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/play-machine-server.noshado.ws/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/play-machine-server.noshado.ws/privkey.pem
</VirtualHost>
</IfModule> 